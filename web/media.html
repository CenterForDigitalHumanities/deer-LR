<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="css/lr.css">
    </head>
    <body>
        <div class="container">
            <!-- <lr-media-upload></lr-media-upload> -->
            <div class="row">
                <form id="form1" enctype="multipart/form-data" method="post" action="uploadFile()">
                    <div class="row">
                      <label for="file">Select a File to Upload</label><br />
                      <input type="file" name="file" id="fileToUpload" onchange="fileSelected();"/>
                    </div>
                    <div id="fileName"></div>
                    <div id="fileSize"></div>
                    <div id="fileType"></div>
                    <div class="row">
                      <input type="button" onclick="uploadFile()" value="Upload" />
                    </div>
                    <div id="progressNumber"></div>
                </form>
            </div>
            
            <div class="row">
                <p>Below are all the files in the bucket.  Click one to download.</p>
                <ul id="availableS3Files">
                    
                </ul>
            </div>
        </div>
        <script src="./js/app.js" type="text/javascript"></script>
        <script src="./js/components.js" type="text/javascript"></script>
    </body>
    <script>
        function fileSelected() {
            var file = document.getElementById('fileToUpload').files[0];
            if (file) {
              var fileSize = 0;
              if (file.size > 1024 * 1024)
                fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
              else
                fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';

              document.getElementById('fileName').innerHTML = 'Name: ' + file.name;
              document.getElementById('fileSize').innerHTML = 'Size: ' + fileSize;
              document.getElementById('fileType').innerHTML = 'Type: ' + file.type;
            }
        }
        
        async function listFilesForDownload(){
            fetch("http://localhost:8080/S3/listFiles", {
                method: "GET",
                mode: "cors",
                body: fileInput.files[0]
            })
            .then(resp => resp.text())
            .then(resp => {
                resp = resp.susbtring(1) //remove [
                resp = resp.slice(0, -1) // remove ]
                let arr = resp.split(",");
                arr.forEach(file => {
                    // Note that file is the S3 'key' for the item in the bucket.
                    let li = `<li><a onclick="downloadFile("${file}")"> ${file} </a></li>`
                })
                return arr
            })
            .catch(err => {
                console.error(err);
                return []
            })
            
            return filesArr
        }
        
        async function downloadFile(key){
            fetch("http://localhost:8080/S3/downloadFile?key="+key)
            .then(resp => {
                console.log("Got the response from the upload file servlet");
                consle.log(resp);
            })
            .catch(err => {
                console.error(err);
            })
        }
        
        async function uploadFile() {
            //NOTE there is no file upload progress with fetch API...
            /*
            fetch("http://localhost:8080/S3/uploadFile", {
                method: "POST",
                mode: "cors",
                body: fileInput.files[0]
            })
            .then(resp => {
                console.log("Got the response from the upload file servlet");
                consle.log(resp);
            })
            .catch(err => {
                console.error(err);
            })
             */
            let xhr = new XMLHttpRequest();
            let form_data = new FormData(document.getElementById('form1'))

            /* event listners */
            xhr.upload.addEventListener("progress", uploadProgress, false);
            xhr.addEventListener("load", uploadComplete, false);
            xhr.addEventListener("error", uploadFailed, false);
            xhr.addEventListener("abort", uploadCanceled, false);
            /* Be sure to change the url below to the url of your upload server side script */
            xhr.open("POST", "http://localhost:8080/S3/uploadFile");
            xhr.send(form_data);
            
        }
          
        function uploadProgress(evt) {
            if (evt.lengthComputable) {
              var percentComplete = Math.round(evt.loaded * 100 / evt.total);
              document.getElementById('progressNumber').innerHTML = percentComplete.toString() + '%';
            }
            else {
              document.getElementById('progressNumber').innerHTML = 'unable to compute';
            }
        }

        function uploadComplete(evt) {
            /* This event is raised when the server send back a response */
            alert(evt.target.responseText);
        }

        function uploadFailed(evt) {
            alert("There was an error attempting to upload the file.");
        }

        function uploadCanceled(evt) {
            alert("The upload has been canceled by the user or the browser dropped the connection.");
        }  
    </script>
</html>
