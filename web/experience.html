<!DOCTYPE html>
<!--
    author: Bryan Haberberger <bryan.j.haberberger@slu.edu>
    -->
<html>

<head>
    <title>New Experience</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/chota@latest">
    <style>
        #experienceReview h4{
            margin: 0px;
        }
        
        #experienceReview p{
            font-size:10pt;
        }
        
      
        #fieldNotesFloater{
            position: fixed;
            left: 0;
            width: 40px;
            height: 40px;
            transition: width 1.5s, box-shadow 2s;
            -webkit-transition: width 1.5s, box-shadow 2s;
            background-color: lightgray;
        }
        
        .fieldNotesInnards{
            
        }
        
        #notesIcon{
            position: absolute;
            top: 0;
            left: 0;
            height: 40px;
            width: 40px;
            cursor: pointer;
        }
        
        #notesIcon:hover{
            border: 2px solid black;
        }
        
        #notesInfo{
            position: relative;
        }
        
        #notesTitle{
            text-align:center;
        }
        
        #fieldNotes textarea{
            height: 185px;
            max-width: 500px;
            max-height: 300px;
            font-size: 90%;
        }
    </style>
</head>

<body>
    <lr-nav></lr-nav>
    <div class="container">
        <!-- Make this show-hide in a corner or something. -->
        <h2 class="text-primary">Upload Data From An Experience</h2>
        <div class="card is-hidden" id="fieldNotesFloater" expanded="false">
            <div class="card_body">
                <h6 id="notesTitle" class="fieldNotesInnards is-hidden" ><span class="theUserName"></span> 's Field Notes </h6>
                <img id="notesIcon" src="https://icongr.am/material/note-text-outline.svg?size=40" title="Field Notes" alt="Field Notes" onclick="LR.ui.toggleFieldNotes(event)"/>
                <p id="notesInfo" class="fieldNotesInnards is-hidden">Enter field notes from your experience here.  You can continue to update these as you upload more information.</p>
                <!-- This is it's own schema.org/Comment object which is about the experience created by the experience creator-->
                <!-- When rendering an experience, we will have to ask for this separately since it is not created as an Annotation targeting the Event -->
                <form id="fieldNotes" class="fieldNotesInnards is-hidden" deer-type="Comment" deer-item-type="simple"> <!-- Comment conforms to what Field Notes are -->
                    <input type="hidden" deer-key="creator"/> <!-- who wrote the notes -->
                    <input type="hidden" deer-key="additionalType" value="LR:FieldNotes">
                    <input class="expReference" type="hidden" deer-key="about"/> <!-- The experience the notes are about.  Experience itself does not track these like other annotations/artifacts -->
                    <textarea id="fieldNotesFromExperience" type="text" deer-key="text" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset006741.html"> </textarea>
                    <div class="row">
                        <input class="button primary" type="submit" value="Save Notes" />.
                        <!--<a class="button primary col" onclick="LR.utils.updateFieldNotes(event)"> Save Notes </a>-->
                    </div>
                </form>
            </div>
        </div>
        <div id="startExperience" class="card bd-primary">
            <div class="card_body">
                <form id="theExperience" class="experience" deer-type="Event">
                    <input type="hidden" deer-key="creator" />
                    <input type="hidden" deer-key="@context" value="https://schema.org/" />
                    <input type="hidden" deer-key="additionalType" value="LR:ExperienceUpload"/>
                    <!-- We are going to do field notes a little differently and not track them as annotations, but as independent objects to query for separately. -->
                    <!--<input type="hidden" deer-key="comment" />-->
                    <input id="senses" type="hidden" deer-key="LR:Senses" deer-input-type="Set" />
                    <input id="practices" type="hidden" deer-key="LR:Practices" deer-input-type="Set" />
                    <input id="objects"  type="hidden" deer-key="object"  deer-input-type="Set"  />
                    <label>Provide a label if desired.</label>
                    <input id="uploadLabel" type="text" deer-key="label" />
                    <label>Select which location this data entry is concerned with.</label>
                    <input type="hidden" deer-key="location" />
                    <deer-view deer-collection="LivedReligionLocations" deer-template="locationsAsDropdown"></deer-view>
                    <!--TODO allow time range??-->
                    <label> On what date was this data gathered?</label>
                    <input type="date" deer-key="startDate" />
                    <label> Select the researchers involved. Hold <kbd>CTRL</kbd> to make multiple selections. </label>
                    <input deer-input-type="Set" type="hidden" deer-key="contributor" value="Bryan H., Patrick C., Adam P." />
                    <deer-view id="researchers" deer-collection="LivedReligionResearchers" deer-template="personMulti"></deer-view>
                    <label>Provide a description of what prompted you to do this</label>
                    <textarea deer-key="description"></textarea>
                    <label>Tags separated by ',':</label>
                    <input disabled type="text" deer-key-x="LR:Tags">   
                    <input type="submit" value="Continue" />
                </form>
            </div>
        </div>
        <div id="experienceReview" class="card is-hidden">
            <div class="card_body">
                <deer-view deer-listening="theExperience" deer-template="Event"></deer-view>
                <h4>Objects at experience "<span class="theExperienceName"></span>"</h4>
                <p>Objects you add will appear here and can be removed, but not edited.</p>
                <ul id="objectsInExperience"></ul>
                <h4>Senses at experience "<span class="theExperienceName"></span>"</h4>
                <p>Senses you add will appear here and can be removed, but not edited.</p>
                <ul id="sensesInExperience"></ul>
                <h4>Practices occurring at experience "<span class="theExperienceName"></span>"</h4>
                <p>Practices you add will appear here and can be removed, but not edited.</p>
                <ul id="practicesInExperience"></ul>
                <h4><a onclick="LR.ui.toggleFieldNotes()">Field Notes</a> from experience "<span class="theExperienceName"></span>"</h4>
                <ul id="fieldNotesInExperience">
                    <li>The field notes for the experience will appear here as yoy make changes to them.</li>
                </ul>
            </div>
        </div>
        <div id="experienceArtifacts" class="fixDynamicHeight is-hidden">
            <h2 class="text-primary">Describe your encounter at <span class="theLocationName">{Place.name}</span> </h2>
            <label>Add information about the space, objects and the activities that happened during this experience.  Select a category to get started.</label>
            <div class="row">
                <!--<a class="button bg-secondary is-small"  area="spaces" onclick="" title="Record information about the location at which this experience took place.">Space</a>-->
                <a class="button primary" area="objects" onclick="LR.ui.toggleAreas(event)" title="Record information about the various objects in the vicinity of the experience.">Objects</a>
                <a class="button primary" area="bodies" onclick="LR.ui.toggleAreas(event)" title="Record more intimate information about what you are perceiving in your immediate vicinity.">Bodies</a>
            </div>
            <!--The Space information was captured when the Location was created.  Show it and offer the user a chance to add additional information--> 
            <!--
            <div tog="spaces" class="kind hidden">
            </div>
            -->
            <div tog="objects" class="kind is-hidden">
                <h2> Objects </h2>
                <p> Below are some objects you can choose from.  You may also opt to record a new object. </p>
                <div id="objectsCollection" deer-collection="LivedReligionObjects" class="deer-view col" deer-link="object.html?id=" deer-template="objectMulti">No objects.</div>
                <h2 class="text-primary">Create a New Object</h2>
                <div class="card bd-primary">
                    <div class="card_body">
                        <form id="newObjectForm" class="hidden" deer-type="Thing" deer-context="http://schema.org">
                            <input type="hidden" deer-key="creator" value="loading"> <!-- Object I am entering -->
                            <input type="hidden" deer-key="targetCollection" value="LivedReligionObjects"> <!-- into this collection -->
                            <!-- That was referenced as being at this experience, supposed to be for Place so not exactly kosher -->
                            <input class="expReference" type="hidden" deer-key="containedIn">  <!--That was referenced as being at this experience or location, supposed to be for Place so not exactly kosher -->
                            <label>Name:</label>
                            <input type="text" deer-key="name">
                            <input id="additionalTypeInput" type="hidden" deer-key="additionalType">
                            <label>Type:</label>
                            <div class="row">
                                <div data-rdf="SacredObject" class="bd-primary text-center card col" title="Sacred Object">
                                    <header>Sacred Object</header>
                                    <img class="hide-xs" src="https://icongr.am/material/star-four-points-outline.svg?size=64&color=##14854f" title="Sacred Object" alt="Sacred Object">
                                </div>
                                <div data-rdf="VisualArtwork" class="bd-primary text-center card col" title="Artwork">
                                    <header>Artwork</header>
                                    <img class="hide-xs" src="https://icongr.am/material/account-box-outline.svg?size=64&color=##14854f" title="Artwork" alt="Artwork">
                                </div>
                                <div data-rdf="Manuscript" class="bd-primary text-center card col" title="Written Text">
                                    <header>Written Text</header>
                                    <img class="hide-xs" src="https://icongr.am/material/book-open.svg?size=64&color=##14854f" title="Written Text" alt="Written Text">
                                </div>
                                <div data-rdf="CivicStructure" class="bd-primary text-center card col" title="Building">
                                    <header>Building</header>
                                    <img class="hide-xs" src="https://icongr.am/material/office-building.svg?size=64&color=##14854f" title="Building" alt="Building">
                                </div>
                            </div>
                            <script>
                                var data_key_elements = document.querySelectorAll("[data-rdf]")
                                Array.from(data_key_elements).forEach(el => el.onclick = setPrimaryType)
                                function setPrimaryType(event) {
                                    let val = event.target ? event.target.closest("[data-rdf]").getAttribute("data-rdf") : event.value
                                    additionalTypeInput.value = val
                                    Array.from(data_key_elements).forEach(el => {
                                        el = el.closest("[data-rdf]")
                                        if (el.getAttribute("data-rdf") === val) {
                                            el.classList.add("bg-light")
                                        } else {
                                            el.classList.remove("bg-light")
                                        }
                                    })
                                }
                            </script>
                            <div class="grouped">
                                <label>Further Options</label>
                                <select oninput="setPrimaryType(this)">
                                    <option value="LR:Clothing" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset003521.html">Clothing</option>
                                    <option value="LR:Food" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset007265.html">Food</option>
                                    <option value="LR:Natural" context=""">Natural</option>
                                    <option value="LR:Manufactured" context="">Manufactured</option>
                                    <option value="Found" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset020912.html">Found</option>
                                    <option value="Spoken" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset017218.html">Spoken</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <h4>History of this Object</h4>
                            <label>Select Former Location(s):</label>
                            <input type="hidden" deer-input-type="List" deer-key="LR:FormerLocations"/>
                            <deer-view deer-collection="LivedReligionLocations" deer-template="locationsMulti"></deer-view> 
                            <label>Select Former Use(s):</label>
                            <input type="hidden" deer-key="LR:formerUses" deer-input-type="List">
                            <!-- Looking at these as "former types", so just reuse the type values -->
                            <select multiple disabled oninput="this.previousElementSibling.value=JSON.stringify(Array.from(this.selectedOptions).map(e=>e.value))">
                                <option value="SacredObject">Sacred Object</option>
                                <option value="VisualArtwork">Artwork</option>
                                <option value="LR:Clothing" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset007265.html">Clothing</option>
                                <option value="LR:Food" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset003521.html">Food</option>
                                <option value="CivicStructure">Building</option>
                                <option value="LR:Natural">Natural</option>
                                <option value="LR:Manufactured">Manufactured</option>
                                <option value="LR:Found" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset020912.html">Found</option>
                                <option value="Manuscript">Written Text</option>
                                <option value="LR:Spoken" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset017218.html">Spoken</option>
                                <option value="Other">Other</option>
                            </select>
                            <h4>Descriptive Information</h4>
                            <label>Material(s) this object is made of:</label>
                            <!-- This should probably be a Set -->
                            <textarea deer-key="material"> </textarea>
                            <label>Typical Use: </label>
                            <select disabled deer-key="purpose" >
                                <option value="Religious">Religious</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Educational">Educational</option>
                                <option value="Civic">Civic</option>
                                <option value="Other Public">Other Public</option>
                            </select>
                            <!-- TODO -->
                            <!--<h3> Upload Media </h3>-->
                            <label title="Provide a short decription of this object with otherwise unprovided or disambiguating details.">Abstract About Object</label>
                            <textarea id="further_object" type="text" deer-key="description"></textarea>
                            <label>Tags separated by ',':</label>
                            <input disabled type="text" deer-key-x="LR:Tags">  
                            <div class="row">
                                <input class="button primary col" type="submit">
                            </div>
                        </form>
                    </div>   
                </div>
            </div>
            <div tog="bodies" class="kind is-hidden">
                <h2>Bodies</h2>
                <p> More intimate information about what you are feeling and perceiving. </p>
                <div class="card bd-primary">
                    <div class="card_body">
                        <!-- I smelled this, I heard that, during this event (geo)... -->
                        <form id="newSenseForm" deer-type="ConsumeAction" deer-item-type="simple">
                            <h4>What senses are prominent?  Add one at a time.</h4>
                            <input type="hidden" deer-key="creator" value="loading"> <!-- Sense I had -->
                             <!-- At this location AKA Geo -->
                            <input class="expReference" type="hidden" deer-key="event" value="">
                            <select deer-key="additionalType">
                                <option value="LR:Sight">I see...</option>
                                <option value="LR:Sound">I hear...</option>
                                <option value="LR:Taste">I taste...</option>
                                <option value="LR:Touch">I feel...</option>
                                <option value="LR:Smell">I smell...</option>
                            </select>
                            <label>Was there a specific object at the experience connected with this sense?</label>
                            <input type="hidden" deer-key="object" value=""> <!-- I heard {object} -->
                            <div deer-collection="LivedReligionObjects" class="deer-view col" deer-template="objectsAsDropdown"></div>
                            <label title="Provide a short decription of this sense with otherwise unprovided or disambiguating details.">Abstract About Sense</label>
                            <textarea id="further_sense" type="text" deer-key="description"></textarea>
                            <div class="row">
                                <input class="button primary col" type="submit">
                            </div>
                        </form>

                        <h4>What practices are occurring? Add one at a time.</h4>
                        <form id="newPracticeForm" deer-type="Action" deer-item-type="simple">
                            <input type="hidden" deer-key="creator" value="loading"> <!-- Practice that I noticed -->
                            <!-- At this event/location/geo -->
                            <input class="expReference" type="hidden" deer-key="event"> 
                            <select deer-key="additionalType">
                                <option value="None">None Noted</option>
                                <option value="EatAction">Eating</option>
                                <option value="DrinkAction">Drinking</option>
                                <option value="PlayAction">Playing</option>
                                <option value="LR:ClotheAction">Clothing</option>
                                <option value="LR:SingAction">Singing</option>
                                <option value="MoveAction">Moving</option>
                                <option value="LR:SitAction">Sitting</option>
                                <option value="LR:StandAction">Standing</option>
                                <option value="LR:KneelAction">Kneeling</option>
                                <option value="LR:TravelAction">Traveling</option>
                                <option value="LR:DanceAction">Dancing</option>
                                <option value="CookAction">Cooking</option>
                                <option value="LR:WorkAction">Working</option>
                                <option value="ListenAction">Listening</option>
                                <option value="WatchAction">Watching</option>
                                <option value="WriteAction">Writing</option>
                                <option value="TradeAction">Trading</option>
                                <option value="GiveAction">Donating</option>
                                <option value="Other">Other</option>
                            </select>
                            <label title="Provide a short decription of this practice with otherwise unprovided or disambiguating details.">Abstract About Practice</label>
                            <textarea id="further_practice" type="text" deer-key="description"></textarea>
                            <select deer-key="LR:ActionContext">
                                <option value="Religious Ritual">Religious Ritual</option>
                                <option value="Community Event">Community Event</option>
                                <option value="Civic Ritual">Civic Ritual</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Public">Public</option>
                                <option value="Private">Private</option>
                                <option value="Planned">Planned</option>
                                <option value="Spontaneous">Spontaneous</option>
                                <option value="Individual">Individual</option>
                                <option value="Collective">Collective</option>
                                <option value="Other">Other</option>
                            </select>
                            <label>Is there a particular object this practice is associated with?</label>
                            <input type="hidden" deer-key="object" value=""> 
                            <div deer-collection="LivedReligionObjects" class="deer-view col" deer-template="objectsAsDropdown"></div>
                            <div class="row">
                                <input class="button primary col" type="submit">
                            </div>
                        </form>        
                    </div>
                </div>                    
            </div>
        </div>
    </div>
    <lr-footer></lr-footer>
    <!-- Add ins -->
    <script>
        /**
         * Set the input fields of forms that include the user id for attribution.
         * Ex. input[deer-key="creator"]
         */
        addEventListener('lrUserKnown', event => {
            LR.utils.setUserAttributionFields(event.detail.user)
        })
        
        /**
         * Once the experience is created, show the area(s) for adding experience artifcats.
         * Also show the created experience details. Set theLocationName.
         */
        addEventListener('deer-created', event => {
            let what = event.target.id
            let newObjID = event.detail["@id"]
            let newObjName = (event.detail.hasOwnProperty("name")) ? event.detail.name : (event.detail.hasOwnProperty("label")) ?  event.detail.label : (event.detail.hasOwnProperty("title")) ? event.detail.title : "Name Unknown"
            let expID = document.getElementById("theExperience").getAttribute("deer-id")
            switch(what){
                case "theExperience":
                    document.getElementById("startExperience").classList.add("is-hidden")
                    document.getElementById("experienceArtifacts").classList.remove("is-hidden")
                    document.getElementById("experienceReview").classList.remove("is-hidden")
                    document.getElementById("fieldNotesFloater").classList.remove("is-hidden")
                    let e = event.target.querySelector(".locDropdown")
                    let locName = e.options[e.selectedIndex].text
                    document.querySelectorAll(".theExperienceName").forEach(elem => elem.innerHTML = newObjName)
                    document.querySelectorAll(".theLocationName").forEach(elem => elem.innerHTML = locName)
                    document.querySelectorAll(".expReference").forEach(elem => elem.value = newObjID)
                break
                case "newObjectForm":
                    document.querySelector("a[area='objects']").click()
                    let obj_list = document.getElementById("objectsInExperience")
                    let obj_li = `<li>${newObjName}<a class="tag is-rounded is-small text-error" onclick="LR.utils.disassociateObject(event, '${newObjID}', '${expID}')">Remove</a></li>`
                    obj_list.innerHTML += obj_li
                    let objs_tracked = document.getElementById("objects").value
                    let objs_delim = document.getElementById("objects").hasAttribute("deer-array-delimeter") ? document.getElementById("objects").getAttribute("deer-array-delimeter") : ","
                    if(objs_tracked){
                        objs_tracked += `${objs_delim}${newObjID}`
                    }
                    else{
                        objs_tracked = newObjID
                    }
                    /**
                     * Improvement idea here.  Maybe don't make each action fire a click() to trigger the update action.
                     * Instead, queue up locally and offer [Commit These Objects To Experience] to limit server interaction.
                     */
                    document.getElementById("objects").value = trackedObjs
                    document.getElementById("objects").$isDirty = true //This DEER thing was tricky to know off hand.  3rd party developers may struggle to know to do this.
                    document.getElementById("theExperience").$isDirty = true
                    //NOTE form.submit() does not create/fire the submit event.  This is a problem for our 3rd party software, DEER.
                    document.getElementById("theExperience").querySelector("input[type='submit']").click() //Update experience form with new object array
                    alert("Object Added!") //TODO FEEDBACK
                break
                case "newSenseForm": 
                    document.querySelector("a[area='bodies']").click()
                    let sense_list = document.getElementById("sensesInExperience")
                    let sense_li = `<li>${newObjName}<a class="tag is-rounded is-small text-error" onclick="LR.utils.disassociateObject(event, '${newObjID}', '${expID}')">Remove</a></li>`
                    sense_list.innerHTML += sense_li
                    let senses_tracked = document.getElementById("senses").value
                    let senses_delim = document.getElementById("senses").hasAttribute("deer-array-delimeter") ? document.getElementById("senses").getAttribute("deer-array-delimeter") : ","
                    if(senses_tracked){
                        senses_tracked += `${senses_delim}${newObjID}`
                    }
                    else{
                        senses_tracked = newObjID
                    }
                    /**
                     * Improvement idea here.  Maybe don't make each action fire a click() to trigger the update action.
                     * Instead, queue up locally and offer [Commit These Objects To Experience] to limit server interaction.
                     */
                    document.getElementById("senses").value = senses_tracked
                    document.getElementById("senses").$isDirty = true //This DEER thing was tricky to know off hand.  3rd party developers may struggle to know to do this.
                    document.getElementById("theExperience").$isDirty = true
                    //NOTE form.submit() does not create/fire the submit event.  This is a problem for our 3rd party software, DEER.
                    document.getElementById("theExperience").querySelector("input[type='submit']").click() //Update experience form with new object array
                    alert("Sense Recorded!");
                case "newPracticeForm":
                    document.querySelector("a[area='bodies']").click()
                    let practice_list = document.getElementById("practicesInExperience")
                    let practice_li = `<li>${newObjName}<a class="tag is-rounded is-small text-error" onclick="LR.utils.disassociateObject(event, '${newObjID}', '${expID}')">Remove</a></li>`
                    practice_list.innerHTML += practice_li
                    let practices_tracked = document.getElementById("practices").value
                    let practices_delim = document.getElementById("practices").hasAttribute("deer-array-delimeter") ? document.getElementById("practices").getAttribute("deer-array-delimeter") : ","
                    if(practices_tracked){
                        practices_tracked += `${practices_delim}${newObjID}`
                    }
                    else{
                        practices_tracked = newObjID
                    }
                    /**
                     * Improvement idea here.  Maybe don't make each action fire a click() to trigger the update action.
                     * Instead, queue up locally and offer [Commit These Objects To Experience] to limit server interaction.
                     */
                    document.getElementById("practices").value = practices_tracked
                    document.getElementById("practices").$isDirty = true //This DEER thing was tricky to know off hand.  3rd party developers may struggle to know to do this.
                    document.getElementById("theExperience").$isDirty = true
                    //NOTE form.submit() does not create/fire the submit event.  This is a problem for our 3rd party software, DEER.
                    document.getElementById("theExperience").querySelector("input[type='submit']").click() //Update experience form with new object array
                    alert("Practice Recorded")
                break
                case "fieldNotes":
                    alert("Notes Saved!") //TODO FEEDBACK
                break
                default:
                    
            }
        })
        
        addEventListener('deer-updated', event => {
            let what = event.target.id
            //Not sure we will do anything with this.  We could use it to offer feedback.  
            switch(what){
                case "theExperience":
                    //We may not offer feedback or anything here.  This happened because the experience was updated from an obj-space-body item addition/removal, which has its own feedback
                break
                case "fieldNotes":
                    //TODO We need to offer some kind of feedback here.  
                break
                default:
                    
            }
        })
        
        addEventListener('deer-loaded', event => {
            let what = event.target.id
            switch(what){
                case "newObjectForm":
                    //An object form was submitted and DEER handled all the annotations and reloaded it.  Remove all the DEER attributes so that when we save it a new item is created.
                    LR.utils.scrubForm(event.target) //Clear out all DEER attributes and input values of the form so the next submission will CREATE
                break
                case "newSenseForm":
                    //A sense form was submitted and DEER handled all the annotations and reloaded it.  Remove all the DEER attributes so that when we save it a new item is created.
                    LR.utils.scrubForm(event.target) //Clear out all DEER attributes and input values of the form so the next submission will CREATE
                break
                case "newPracticeForm":
                    //A practice form was submitted and DEER handled all the annotations and reloaded it.  Remove all the DEER attributes so that when we save it a new item is created.
                    LR.utils.scrubForm(event.target) //Clear out all DEER attributes and input values of the form so the next submission will CREATE
                break
                default:
                    
            }
        })
    </script>
    <script src="./js/deerInitializer.js" type="module"></script>
    <script src="./js/app.js" type="text/javascript"></script>
    <script src="./js/components.js" type="text/javascript"></script>
</body>

</html>
