<!DOCTYPE html>
<!--
    author: Bryan Haberberger <bryan.j.haberberger@slu.edu>
    -->
<html>

<head>
    <title>New Experience</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/chota@latest">
</head>

<body>
    <lr-nav></lr-nav>
    <div class="container">
        <h2 class="text-primary">Upload Data From An Experience</h2>
        <div id="startExperience" class="card bd-primary">
            <div class="card_body">
                <form id="theExperience" class="experience" deer-type="Event">
                    <input type="hidden" deer-key="creator" />
                    <input type="hidden" deer-key="@context" value="https://schema.org/" />
                    <input id="objectsAtExperience" type="hidden" deer-key="object" deer-input-type="Set" />
                    <label>Provide a label if desired.</label>
                    <input id="uploadLabel" type="text" deer-key="label" />
                    <label>Select which location this data entry is concerned with.</label>
                    <input id="loc" type="hidden" deer-key="location" />
                    <deer-view id="locations" deer-collection="LivedReligionLocationsTest" deer-template="locationsAsDropdown"></deer-view>
                    <!--TODO allow time range??-->
                    <label> On what date was this data gathered?</label>
                    <input type="date" deer-key="startDate" />
                    <label> Select the researchers involved. Hold <kbd>CTRL</kbd> to make multiple selections. </label>
                    <input deer-input-type="Set" type="hidden" deer-key="contributor" value="Bryan H., Patrick C., Adam P." />
                    <deer-view id="researchers" deer-collection="LivedReligionResearchersTest" deer-template="personMulti"></deer-view>
                    <input id="objects" deer-input-type="Set" type="hidden" deer-key="object" />
                    <input type="submit" value="Continue" />
                </form>
            </div>
        </div>
        <div id="experienceReview" class="card is-hidden">
            <div class="card_body">
                <deer-view deer-listening="theExperience" deer-template="Event"></deer-view>
                <h4>Objects at experience "<span id="theExperienceName"></span>"</h4>
                <ul id="objectsInExperience">
                    <li>Objects you add will appear here and can be removed, but not edited.</li>
                </ul>
            </div>
        </div>
        <div id="experienceArtifacts" class="fixDynamicHeight is-hidden">
            <h2 class="text-primary">Describe your encounter at <span id="theLocationName">{Place.name}</span> </h2>
            <label>Add information about the space, objects and the activities that happened during this experience.  Select a category to get started.</label>
            <div class="row">
                <a class="button bg-secondary is-small"  area="spaces" onclick="" title="Record information about the location at which this experience took place.">Space</a>
                <a class="button bg-primary is-small" area="objects" onclick="LR.ui.toggleAreas(event)" title="Record information about the various objects in the vicinity of the experience.">Objects</a>
                <a class="button bg-secondary is-small" area="bodies" onclick="" title="Record information about others' behaviors during the experience.">Bodies</a>
            </div>
             <!--The Space information was captured when the Location was created.  Show it and offer the user a chance to add additional information--> 
            <!--
            <div for="spaces" class="kind hidden">
                 Here the user can offer additional information about the Location.  They cannot change or delete existing information. 
                <form id="chosenLocation" class="dataWrap" for="spaces" deer-type="Place">
                     TODO make tyhe deer-id of this the id from the chosen location.  Preload information into the form. 
                    <input type="hidden" deer-key-x="annoConnectingToExperience" />
                    <label> Primary Type </label>
                    <input disabled type="text" deer-key-x="type" />
                    <div class="secondarySpecification hidden" for="spaces">
                        <header>Check all other types for this space.</header>
                        <label>General Specification</label>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Accommodation" /><span class="chk_lbl">Accommodation</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="AdministrativeArea" /><span class="chk_lbl">Administrative Area</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Civic Structure" /><span class="chk_lbl">Civic Structure</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Landform" /><span class="chk_lbl">Landform</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Other Building" /><span class="chk_lbl">Other Building</span>
                        same properties as Place and Intangible in schema, but this is like LR::Imagined because no schema exists
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Imagined" /><span class="chk_lbl">Imagined</span>
                        <br>
                        <label>More Specific</label>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Landmarks or Historical Buildings" /><span class="chk_lbl">Landmarks or Historical Buildings</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Local Business" /><span class="chk_lbl">Local Business</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Residence" /><span class="chk_lbl">Residence</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="School" /><span class="chk_lbl">School</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Tourist Destination" /><span class="chk_lbl">Tourist Destination</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Neighborhood" /><span class="chk_lbl">Neighborhood</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Home" /><span class="chk_lbl">Home</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Cemetery" /><span class="chk_lbl">Cemetery</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Hospital" /><span class="chk_lbl">Hospital</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Museum" /><span class="chk_lbl">Museum</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Park" /><span class="chk_lbl">Park</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Street" /><span class="chk_lbl">Street</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Zoo" /><span class="chk_lbl">Zoo</span>
                        <input type="checkbox" onchange="LR.ui.reactiveSecondaryType(event, 'spaces')" value="Gym" /><span class="chk_lbl">Gym</span>
                        <input deer-key-x="additionalType" type="checkbox" onchange="LR.ui.reactiveOther(event, 'spaces')" value="Other Building" /><span class="chk_lbl">Other Building</span>
                        <div class="reactiveOther hidden" for="spaces">
                            <label>Please tell us what you mean by other:</label>
                            <textarea type="text"> </textarea>
                        </div>
                    </div>
                    <input type="hidden" deer-input-type-x="Set" deer-key-x="additionalType" />
                    <label>What is this space named?:</label>
                    <input disabled type="text" deer-key-x="name" />
                    <header>History of this Space:</header>
                    <textarea type="text" deer-key-x="LR::SpaceHistory"> </textarea>
                    <label>Former Location(s):</label>
                    <textarea type="text" deer-key-x="LR::FormerLocations"> </textarea>
                    <label>Former Use(s):</label>
                    <textarea type="text" deer-key-x="LR::FormerUses"> </textarea>
                    <label>Creator:</label>
                    <input disabled type="text" deer-key-x="creator" />
                    <label>Material(s):</label>
                    <textarea type="text" deer-key-x="material"> </textarea>
                    <label>Further Description:</label>
                    <textarea type="text" deer-key-x="description"> </textarea>
                    <div class="dataWrap">
                        <label>Typical Use: </label>
                        <select disabled deer-key-x="typical_use" value="">
                            <option value="Religious">Religious</option>
                            <option value="Commercial">Commercial</option>
                            <option value="Educational">Educational</option>
                            <option value="Civic">Civic</option>
                            <option value="Other Public">Other Public</option>
                        </select>
                    </div>
                    <div> Upload Media </div>
                    <label>Field Notes:</label>
                    <textarea type="text" deer-key-x="notes"> </textarea>
                    <label>Tags separated by ',':</label>
                    <textarea type="text" deer-key-x="tag"> </textarea>
                </form>
            </div>
            -->
            <div tog="objects" class="kind is-hidden">
                <h2> Objects </h2>
                <p> Below are some objects you can choose from.  You may also opt to record a new object. </p>
                <div id="objectsCollection" deer-collection="LivedReligionObjectsTest" class="deer-view col" deer-link="object.html?id=" deer-template="objectMulti">No objects.</div>
                <h2 class="text-primary">Create a New Object</h2>
                <div class="card bd-primary">
                    <div class="card_body">
                        <form id="newObjectForm" class="hidden" deer-type="Thing" deer-context="http://schema.org">
                            <input type="hidden" deer-key="creator" value="loading">
                            <input type="hidden" deer-key="targetCollection" value="LivedReligionObjectsTest">
                            <!--<input class="expReference" type="hidden" deer-key="containedIn" value="{{Experience}}">-->
                            <label>Name:</label>
                            <input type="text" deer-key="name">
                            <input id="additionalTypeInput" type="hidden" deer-key="additionalType">
                            <label>Type:</label>
                            <div class="row">
                                <div data-rdf="SacredObject" class="bd-primary text-center card col" title="Sacred Object">
                                    <header>Sacred Object</header>
                                    <img class="hide-xs" src="https://icongr.am/material/star-four-points-outline.svg?size=64&color=##14854f" title="Sacred Object" alt="Sacred Object">
                                </div>
                                <div data-rdf="VisualArtwork" class="bd-primary text-center card col" title="Artwork">
                                    <header>Artwork</header>
                                    <img class="hide-xs" src="https://icongr.am/material/account-box-outline.svg?size=64&color=##14854f" title="Artwork" alt="Artwork">
                                </div>
                                <div data-rdf="Manuscript" class="bd-primary text-center card col" title="Written Text">
                                    <header>Written Text</header>
                                    <img class="hide-xs" src="https://icongr.am/material/book-open.svg?size=64&color=##14854f" title="Written Text" alt="Written Text">
                                </div>
                                <div data-rdf="CivicStructure" class="bd-primary text-center card col" title="Building">
                                    <header>Building</header>
                                    <img class="hide-xs" src="https://icongr.am/material/office-building.svg?size=64&color=##14854f" title="Building" alt="Building">
                                </div>
                            </div>
                            <script>
                                var data_key_elements = document.querySelectorAll("[data-rdf]")
                                Array.from(data_key_elements).forEach(el => el.onclick = setPrimaryType)

                                function setPrimaryType(event) {
                                    let val = event.target ? event.target.closest("[data-rdf]").getAttribute("data-rdf") : event.value
                                    additionalTypeInput.value = val
                                    Array.from(data_key_elements).forEach(el => {
                                        el = el.closest("[data-rdf]")
                                        if (el.getAttribute("data-rdf") === val) {
                                            el.classList.add("bg-light")
                                        } else {
                                            el.classList.remove("bg-light")
                                        }
                                    })
                                }
                            </script>
                            <div class="grouped">
                                <label>Further Options</label>
                                <select oninput="setPrimaryType(this)">
                                    <option value="LR:Clothing" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset003521.html">Clothing</option>
                                    <option value="LR:Food" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset007265.html">Food</option>
                                    <option value="LR:Natural" context=""">Natural</option>
                                    <option value="LR:Manufactured" context="">Manufactured</option>
                                    <option value="Found" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset020912.html">Found</option>
                                    <option value="Spoken" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset017218.html">Spoken</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <h3>History of this Space:</h3>
                            <label>Select Former Location(s):</label>
                            <input type="hidden" deer-input-type="List" deer-key="LR:FormerLocations"/>
                            <deer-view id="locations" deer-collection="LivedReligionLocationsTest" deer-template="locationsMulti"></deer-view> 
                            <label>Select Former Use(s):</label>
                            <input type="hidden" deer-key="LR:formerUses" deer-input-type="List">
                            <!-- Looking at these as "former types", so just reuse the type values -->
                            <select multiple disabled oninput="this.previousElementSibling.value=JSON.stringify(Array.from(this.selectedOptions).map(e=>e.value))">
                                <option value="SacredObject">Sacred Object</option>
                                <option value="VisualArtwork">Artwork</option>
                                <option value="LR:Clothing" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset007265.html">Clothing</option>
                                <option value="Food" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset003521.html">Food</option>
                                <option value="CivicStructure">Building</option>
                                <option value="LR:Natural">Natural</option>
                                <option value="LR:Manufactured">Manufactured</option>
                                <option value="LR:Found" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset020912.html">Found</option>
                                <option value="Manuscript">Written Text</option>
                                <option value="LR:Spoken" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset017218.html">Spoken</option>
                                <option value="Other">Other</option>
                            </select>
                            <label>Material(s) this object is made of:</label>
                            <!-- This should probably be a Set -->
                            <textarea deer-key="material"> </textarea>
                            <label>Typical Use: </label>
                            <select disabled deer-key="purpose" >
                                <option value="Religious">Religious</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Educational">Educational</option>
                                <option value="Civic">Civic</option>
                                <option value="Other Public">Other Public</option>
                            </select>
                            <!-- TODO -->
                            <!--<h3> Upload Media </h3>-->
                            <label>Field Notes:</label>
                            <textarea type="text" deer-key="LR:FieldNotes" context="http://id.loc.gov/vocabulary/ethnographicTerms/afset006741.html"> </textarea>
                            <label>Tags separated by ',':</label>
                            <input disabled type="text" deer-key-x="LR:Tags">                           
                            <div class="row">
                                <input class="button primary col" type="submit">
                            </div>
                        </form>
                    </div>   
                </div>
            </div>
            <!--
            <div for="bodies" class="kind hidden">
                 TODO design how the experience object aggregates Sense annotations 
                <header>What senses are prominent?</header>
                <form id="senses" deer-id-x="" deer-type-x="Sense">
                    <input type="radio" value="LR::Sight" name="sense"><span class="chk_lbl">Sight</span>
                    <input type="radio" value="LR::Smell" name="sense"><span class="chk_lbl">Smell</span>
                    <input type="radio" value="LR::Sound" name="sense"><span class="chk_lbl">Sound</span>
                    <input type="radio" value="LR::Touch" name="sense"><span class="chk_lbl">Touch</span>
                    <input type="radio" value="LR::Taste" name="sense"><span class="chk_lbl">Taste</span>
                    <input type="hidden" deer-key-x="annoConnectingToExperience" />
                    <header>Describe Sense Further:</header>
                    <textarea id="further_sense" type="text" deer-key-x="description"></textarea>
                    <input type="hidden" deer-key-x="annoConnectingToExperience" />  TODO 
                    <input type="button" onclick="LR.ui.addPieceAndReset(event, 'sense')" value="Add Sense" />
                </form>
                 TODO: Catch the created event for a sense and add into this area 
                <ul id="added_sense">
                    <li>
                        <header> Added Senses </header>
                    </li>
                </ul>
                 TODO Design how experience object aggregates practices.  Is this a collection? 
                 TODO Design what a distinct practice object looks like 
                <header>What practices are occurring? Add one at a time.</header>
                <form id="practices" deer-id-x="" deer-type-x="Practice">
                    <input name="practice" type="radio" value="Eating"><span class="chk_lbl">Eating</span>
                    <input name="practice" type="radio" value="Playing"><span class="chk_lbl">Playing</span>
                    <input name="practice" type="radio" value="Clothing"><span class="chk_lbl">Clothing</span>
                    <input name="practice" type="radio" value="Singing"><span class="chk_lbl">Singing</span>
                    <input name="practice" type="radio" value="Moving"><span class="chk_lbl">Moving</span>
                    <input name="practice" type="radio" value="Sitting"><span class="chk_lbl">Sitting</span>
                    <input name="practice" type="radio" value="Standing"><span class="chk_lbl">Standing</span>
                    <input name="practice" type="radio" value="Kneeling"><span class="chk_lbl">Kneeling</span>
                    <input name="practice" type="radio" value="Traveling"><span class="chk_lbl">Traveling</span>
                    <input name="practice" type="radio" value="Dancing"><span class="chk_lbl">Dancing</span>
                    <input name="practice" type="radio" value="Cooking"><span class="chk_lbl">Cooking</span>
                    <input name="practice" type="radio" value="Working"><span class="chk_lbl">Working</span>
                    <input name="practice" type="radio" value="Other"><span class="chk_lbl">Other</span>
                    <div class="reactiveOther hidden" for="practice">
                        <label>Please tell us what you mean by other:</label>
                        <textarea type="text"> </textarea>
                    </div>
                    <header>Describe Practice Further:</header>
                    <textarea id="further_practice" type="text" deer-key-x="description"></textarea>
                    <input type="hidden" deer-key-x="annoConnectingToExperience" />  TODO 
                    <input type="button" onclick="LR.ui.addPieceAndReset(event, 'practice')" value="Add Practice" />
                </form>
                 TODO 
                <ul id="added_practice">
                    <li>
                        <header> Added Practices </header>
                    </li>
                </ul>
                 TODO Design how experience object aggregates contexts and relates them to the aggregated practices.
                 TODO Design what a distinct practice object looks like 
                <header>What is the context of these practices? Add one at a time.</header>
                <form id="contexts">
                    <input name="context" type="radio" value="Religious Ritual"><span class="chk_lbl">Religious Ritual</span>
                    <input name="context" type="radio" value="Community Event"><span class="chk_lbl">Community Event</span>
                    <input name="context" type="radio" value="Civic Ritual"><span class="chk_lbl">Civic Ritual</span>
                    <input name="context" type="radio" value="Commercial"><span class="chk_lbl">Commercial</span>
                    <input name="context" type="radio" value="Public"><span class="chk_lbl">Public</span>
                    <input name="context" type="radio" value="Private"><span class="chk_lbl">Private</span>
                    <input name="context" type="radio" value="Planned"><span class="chk_lbl">Planned</span>
                    <input name="context" type="radio" value="Spontaneous"><span class="chk_lbl">Spontaneous</span>
                    <input name="context" type="radio" value="Individual"><span class="chk_lbl">Individual</span>
                    <input name="context" type="radio" value="Collective"><span class="chk_lbl">Collective</span>
                    <input name="context" type="radio" value="Other"><span class="chk_lbl">Other</span>
                    <div class="reactiveOther hidden" for="context">
                        <label>Please tell us what you mean by other:</label>
                        <textarea type="text"> </textarea>
                    </div>
                    <header>Describe Context Further:</header>
                    <textarea id="further_context" type="text" deer-key-x="description"></textarea>
                    <input type="hidden" deer-key-x="annoConnectingToPractices" />  TODO 
                    <input type="button" onclick="LR.ui.addPieceAndReset(event, 'context')" value="Add Context" />
                </form>
                 TODO 
                <ul id="added_context">
                    <li>
                        <header> Added Contexts </header>
                    </li>
                </ul>
                 TODO note that these don't make much sense here... 

                <div> Upload Media </div>
                <label>Field Notes:</label>
                <textarea type="text" deer-key-x="notes"> </textarea>
                <label>Tags:</label>
                <textarea type="text" deer-key-x="tags"> </textarea>

            </div>
            -->
        </div>
    </div>
    <lr-footer></lr-footer>
    <!-- Add ins -->
    <script>
        addEventListener('lrUserKnown', event => {
            LR.utils.setUserAttributionFields(event.detail.user)
        })
        
        addEventListener('deer-created', event => {
            //Once the experience is created, show the area(s) for adding experience artifcats
            //Also show the created experience details. Set theLocationName.
            let what = event.target.id
            let newObjID = event.detail["@id"]
            let newObjName = (event.detail.hasOwnProperty("name")) ? event.detail.name : (event.detail.hasOwnProperty("label")) ?  event.detail.label : (event.detail.hasOwnProperty("title")) ? event.detail.title : "Name Unknown"
            switch(what){
                case "theExperience":
                    document.getElementById("startExperience").classList.add("is-hidden")
                    document.getElementById("experienceArtifacts").classList.remove("is-hidden")
                    document.getElementById("experienceReview").classList.remove("is-hidden")
                    document.getElementById("theExperienceName").innerHTML = newObjName
                    let e = document.getElementById("locations").children[0]
                    let locName = e.options[e.selectedIndex].text
                    document.getElementById("theLocationName").innerHTML = locName
                    document.querySelectorAll(".expReference").forEach(elem => elem.value = newObjID)
                break
                case "newObjectForm":
                    //DEER has reported this item created and is ready to track updates against it.  We need to completely clear this form out
                    //so that deer knows we are trying to add a completely new one and to stop tracking the old one, including the annotations
                    document.querySelector("a[area='objects']").click()
                    let expID = document.getElementById("theExperience").getAttribute("deer-id")
                    let list = document.getElementById("objectsInExperience")
                    let li = `<li>${newObjName}<a class="tag is-rounded is-small text-error" onclick="LR.crud.disassociateObject('${newObjID}', '${expID}')">Remove</a></li>`
                    list.innerHTML += li
                    let trackedObjs = document.getElementById("objects").value
                    let delim = document.getElementById("objects").hasAttribute("deer-array-delimeter") ? document.getElementById("objects").getAttribute("deer-array-delimeter") : ","
                    if(trackedObjs){
                        trackedObjs += `${delim}${newObjName}`
                    }
                    else{
                        trackedObjs = newObjName
                    }
                    /**
                     * Improvement idea here.  Maybe don't make each action fire a click() to trigger the update action.
                     * Instead, queue up locally and offer [Commit These Objects To Experience] to limit server interaction.
                     */
                    document.getElementById("objects").value = trackedObjs
                    document.getElementById("objects").$isDirty = true //This DEER thing was tricky to know off hand.  3rd party developers may struggle to know to do this.
                    /**
                     * A valuable lesson learned here:
                     * To submit a form to the server manually, we can call form.submit().  Then the submit event is not generated. 
                     * It is assumed that if the programmer calls form.submit() then the script already did all related processing.
                     * This means the event listener does not fire, which we specifically need here because of DEER.
                     */
                    document.getElementById("theExperience").querySelector("input[type='submit']").click() //Update experience form with new object array
                    LR.utils.scrubForm(event.target) //Clear out all DEER attributes and input values of the form so the next submission will CREATE
                    alert("Object Added!")
                break
                case "senseEntryCreated":
                    //Add this sense item by some name to a list, perhaps with a "remove" option
                    //Empty newSenseForm inputs and prepare it to add another item.  It will never load a known item for edit here.  
                break
                case "practiceEntryCreated":
                    //Add this object item by some name to a list, perhaps with a "remove" option
                    //Empty newPracticeForm inputs and prepare it to add another item.  It will never load a known item for edit here.  
                break
                default:
                    console.log("Default created event handler for " +what)
            }
        })
        
        addEventListener('deer-updated', event => {
            let what = event
            switch(what){
                case "experienceUpdated":
                    //Probably because an object-body-space alteration occurred where someone is adding or removing one from the experience
                    //Updates should really only happen to the experience unless we offer live time editing of experience artifacts. 
                break
                default:
                    console.log("Default update handler for " + what)
            }
        })
    </script>
    <script src="./js/deerInitializer.js" type="module"></script>
    <script src="./js/app.js" type="text/javascript"></script>
    <script src="./js/components.js" type="text/javascript"></script>
</body>

</html>