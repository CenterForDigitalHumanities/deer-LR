<!DOCTYPE html>
<!--
    author: Bryan Haberberger <bryan.j.haberberger@slu.edu>
    @author: cubap@slu.edu
    -->
<html>

<head>
    <title>Religion In Place Researcher</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/chota@latest">
</head>

<body>
    <lr-nav></lr-nav>

    <div class="container">
        <h2 class="text-primary">Create a New Researcher</h2>
        <div class="card bd-primary">
            <div class="card_body">
                <form id="researcherForm" deer-creator deer-type="Person" deer-creator deer-context=http://store.rerum.io/context.json">
                    <input type="hidden" deer-key="creator" value="loading">
                    <input type="hidden" deer-key="targetCollection" value="LivedReligionResearchersTest">
                    <div class="grouped">
                        <label>Name:</label>
                        <input type="text" deer-key="name">
                    </div>
                    <footer>
                        <input class="button primary" type="submit">
                    </footer>
                </form>
            </div>
        </div>
        <h3>Existing Researchers</h3>
        <deer-view deer-collection="LivedReligionResearchersTest" deer-link="?id="></deer-view>
    </div>
    <lr-global-feedback></lr-global-feedback>
    <lr-footer></lr-footer>

    <script src="./js/sysendBroadcaster.js" type="text/javascript"></script>
    <script>
        addEventListener('lrUserKnown', event => {
            let user = event.detail.user
            if(user !== null){
                LR.utils.setUserAttributionFields(user)
                if (user.roles.administrator) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const researcherId = urlParams.get('id');
                    if (researcherId) {
                        researcherForm.setAttribute("deer-id", researcherId)
                        document.querySelector("h2.text-primary").innerHTML = "Update Researcher"
                        document.querySelector("input[type='submit']").value = "Update"
                        let btn = document.createElement("a")
                        btn.href = window.location.pathname
                        btn.innerHTML = "Reset Page"
                        researcherForm.append(btn)
                    }
                }
                else{
                    alert("You must be logged in as an administrator to use this!")
                    document.location.href="dashboard.html"
                }
            }
            else{
                console.log("User identity reset; user is null. ")
                document.location.href="logout.html"
            }
        })
        
        /**
         * Determine what to do when a collection item is deleted
         * @param {type} event
         * @returns {undefined}
         */
        addEventListener('lrCollectionItemDeleted', event => {
            let selector = '[deer-collection=' + event.detail.collection + ']'
            let lists = Array.from(document.querySelectorAll(selector))
             //TODO redraw lists
            LR.ui.globalFeedbackBlip(event, `Researcher '${event.detail.name}' Removed!`, true) //false and make it red, cuz remove??
        })
        
        addEventListener('deer-created', event => {
            LR.ui.globalFeedbackBlip(event, `Researcher '${event.detail.name}' Added!`, true)
        })
        
        addEventListener('deer-updated', event => {
            LR.ui.globalFeedbackBlip(event, `Researcher '${event.detail.name}' Information Updated!`, true)
        })
        
        /**
         * A hack to force redraw by refreshing the page.
         */
        addEventListener('globalFeedbackFinished', event => {
           document.location.reload()
        })
        
                /**
         * Detects that HTML has finished drawing in the DOM and can be interacted with.
         * This most often occures when drawing a deer-view on page load or from redraws.
         * @see deer-render.js RENDER.element
         */
        addEventListener('deer-view-rendered', event => {
            let whatElem = event.target
            let whatData = event.detail
        })
        
        /**
         * Detects that all annotation data is gathered and all HTML of the form is in the DOM and can be interacted with.
         * This is important for pre-filling or pre-selecting values of multi select areas, dropdown, checkboxes, etc. 
         * This event will come after all deer-view-rendered events have finished.
         * @see deer-record.js DeerReport.constructor()  
         */
        addEventListener('deer-form-rendered', event => {
            let whatRecordForm = event.target.id
            let annotationData = event.detail
            switch(whatRecordForm){
                case "researcherForm":
                break
                
                default:
                    
            }
        })
        
       /**
         * Handle Login and Logout across tabs
         */
        local_socket.on('loginError', function(obj) {
            alert("There was a problem logging in.  Refresh the page and try again.")
        })

        local_socket.on('loginFinished', function(obj) {
            //Perhaps it could be more elegant to dispatch the lrUserKnown event.  Socket events are not caught on the page they are generated...
            //Reload does everything we want inside the framework we already built in <lr-login> elements
            document.location.reload()
        })

        local_socket.on('logoutError', function(obj) {
            alert("There was a problem logging out.  Refresh the page and try again.")
        })

        local_socket.on('logoutFinished', function(obj) {
            //obj.fn() would be neat if obj.fn = function(){return LR.utils.logout()} would work...see logout.html
            document.location.href="dashboard.html"
        })
    </script>
    <script src="./js/deerInitializer.js" type="module"></script>
    <script src="./js/app.js" type="text/javascript"></script>
    <script src="./js/components.js" type="text/javascript"></script>

</body>

</html>
